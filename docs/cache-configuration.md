# 🗄️ 缓存配置指南

## 概述

本系统提供灵活的缓存配置选项，支持开启/关闭缓存功能，以适应不同的使用场景和性能需求。

## 🔧 缓存开关配置

### 环境变量

```bash
# 缓存开关 (默认: true)
ENABLE_CACHE=true|false

# 缓存配置 (仅在启用缓存时生效)
CACHE_TTL=300                # 缓存过期时间(秒)
CACHE_MAX_KEYS=10000        # 最大缓存条目数
```

### 配置示例

#### ✅ 启用缓存 (推荐)
```bash
ENABLE_CACHE=true
CACHE_TTL=300
CACHE_MAX_KEYS=10000
```

#### ❌ 禁用缓存
```bash
ENABLE_CACHE=false
# 注意：CACHE_TTL 和 CACHE_MAX_KEYS 在禁用时无效
```

## 📊 缓存开关对性能的影响

### 缓存启用时
| 指标 | 值 |
|------|-----|
| 响应时间 (缓存命中) | < 50ms |
| 响应时间 (缓存未命中) | 200-500ms |
| API调用节省 | 80-90% |
| 内存使用 | +100-500MB |

### 缓存禁用时
| 指标 | 值 |
|------|-----|
| 响应时间 | 200-500ms |
| API调用 | 100% (每次请求都调用API) |
| 内存使用 | 基础内存 |
| API配额消耗 | 10倍增加 |

## 🎯 使用场景

### 推荐启用缓存的场景
- ✅ **生产环境**: 提升性能，节省API配额
- ✅ **高并发应用**: 减少响应时间
- ✅ **API密钥有限**: 最大化利用每日2000次配额
- ✅ **成本敏感**: 降低API调用成本

### 可考虑禁用缓存的场景
- ⚠️ **实时性要求极高**: 需要每次都获取最新数据
- ⚠️ **调试阶段**: 确保每次都调用真实API
- ⚠️ **内存受限**: 服务器内存不足
- ⚠️ **测试环境**: 验证API响应

## 🔍 配置验证

使用配置检查工具验证缓存设置：

```bash
npm run config:check
```

输出示例：
```
📋 当前配置:
  - 缓存开关: 启用/禁用
  - 缓存TTL: 300 秒
  - 缓存最大数量: 10000
```

## 📈 监控缓存状态

### API端点

#### 获取缓存信息
```bash
GET /data/3.0/cache/info
```

响应示例：
```json
{
  "success": true,
  "cache": {
    "enabled": true,
    "status": "active",
    "size": 1500,
    "maxSize": 10000,
    "hitRate": "85.2%",
    "hits": 12750,
    "writes": 2000,
    "ttl": "300s"
  }
}
```

#### 获取详细统计
```bash
GET /stats/cache
```

### 缓存管理

#### 清空缓存
```bash
DELETE /data/3.0/cache
```

缓存禁用时的响应：
```json
{
  "success": false,
  "message": "缓存未启用，无需清空",
  "cacheEnabled": false
}
```

## ⚡ 性能优化建议

### 缓存启用时的优化
1. **TTL设置**: 天气数据建议5分钟 (300秒)
2. **容量规划**: 根据QPS设置合适的maxKeys
3. **监控命中率**: 目标 > 80%

### 缓存禁用时的优化
1. **API密钥数量**: 增加更多密钥
2. **请求去重**: 利用系统的pending请求合并
3. **连接池**: 优化HTTP连接复用

## 🛠️ 动态配置切换

目前需要重启服务来更改缓存设置。未来版本可能支持热重载：

```bash
# 重启服务应用新配置
npm restart

# 或者使用PM2
npm run pm2:restart
```

## 📝 最佳实践

### 生产环境推荐配置
```bash
ENABLE_CACHE=true
CACHE_TTL=300          # 5分钟，平衡实时性和性能
CACHE_MAX_KEYS=20000   # 根据内存和QPS调整
```

### 开发环境配置
```bash
ENABLE_CACHE=true      # 保持与生产一致
CACHE_TTL=60          # 1分钟，便于测试
CACHE_MAX_KEYS=1000   # 较小的缓存大小
```

### 调试环境配置
```bash
ENABLE_CACHE=false     # 确保获取实时数据
```

## 🚨 注意事项

1. **API配额**: 禁用缓存将大幅增加API调用次数
2. **响应时间**: 禁用缓存会增加平均响应时间
3. **内存管理**: 启用缓存需要额外内存开销
4. **数据一致性**: 缓存的数据可能不是最新的

## 📞 故障排查

### 常见问题

**Q: 缓存禁用后性能很差怎么办？**
A: 增加API密钥数量，优化网络连接

**Q: 缓存启用但命中率很低？**
A: 检查请求参数一致性，考虑增加TTL

**Q: 内存使用过高？**
A: 减少CACHE_MAX_KEYS或禁用缓存 